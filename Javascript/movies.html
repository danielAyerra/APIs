<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Your favourite Videoclub is here!</title>
	    <meta charset="UTF-8">
		<script type="text/javascript" src="requestAPI.js"></script>
		<script type="text/javascript">
			let dataRaw;
			let selected;
			/*Why using getCategories when there is getElements method?
			This is done because whenever the page is loaded, there is still no guarantee that dataRaw
			has already the values. So, the data treated is the source, making sure something is loaded.
			And, for further requests, dataRaw can be consulted.*/
			window.onload = async function(){
				const res = await getMethod();
				dataRaw = res;
				classifyInfo(res);
				loadSelect(res);
			}

			const getCategories = function(data){

				return data.clasificaciones;
			}

			const loadSelect = function(data){
				const selList = document.getElementById('selClasificaciones');
				const categoryList = getCategories(data);
				let content='<option value="" selected disabled>--------</option>';
				categoryList.forEach(x=>{
					content+=`<option value="${x.nombre}">${x.nombre}</option>`;
				});
				selList.innerHTML=content;
			}

			const classifyInfo = function(data){
				let content='';
				if(data['peliculas']&&data['clasificaciones']){
					const movies=data['peliculas'];
					const classes=data['clasificaciones'];
					for(let i=0;i<classes.length;i++){
						const clasMovies = searchInfo(movies, classes[i].nombre);
						content+=`<li><h3>${classes[i].nombre}</h3><ul class=movielist>`;
						for(let j=0;j<clasMovies.length;j++){
							content+=`<li><div class='moviecard' id='movie_${clasMovies[j].id}'>
								<h4>Título: ${clasMovies[j].nombre}<h4>
								<p><span>Director: </span>${clasMovies[j].director}</p>
								</div>
								</li>`;
						}
						content+='</ul></li>';
					}
				}
				document.getElementById('mainBody_movies_movieList').innerHTML=content;
			}

			const searchInfo = function(data, term){
				const returnElement = data.filter(el=>el['clasificacion']==term);
				return returnElement;
			}

			const addElement = function(type, ...args){//nombre, director, clasificación
				console.log(args);
				console.log(args.length);
				console.log(type);
				try{
					const oldElements = getElements(type);
					const newElements=oldElements;
					if(type==='clasificaciones'&&args.length===1){
						newElements.push({'nombre':args[0], 'id':oldElements.length+1});
						console.log(newElements);
					} else if(type==='peliculas'&&args.length===3){						
						newElements.push({'nombre':args[0], 'director':args[1], 'clasificacion':args[2], 'id':oldElements.length+1});
						console.log(newElements)
					} else {
						throw new Error('Bad parameter pass.')
					}				
					const newList = dataRaw;
					newList[type]=newElements;
					classifyInfo(newList);
					putMethod(type, newElements[newElements.length-1], newElements.length);
					dataRaw=newList;
				}catch(err){console.error(err.message);}
			}

			const addMovie = function(){
				const movieForm = document.getElementById("adminControl_addMovie");
				console.log(movieForm);
				const movie = []
				if(movieForm[1].value==='' || movieForm[2].value==='' || movieForm[3].value===''){
					window.alert('Missing data. Operation aborted.');
				}
				else{
					for(i=1;i<=3;i++){
						movie.push(movieForm[i].value);
					}
					console.log(movieForm[3]);
					addElement('peliculas', movie[0], movie[1], movie[2]);
				}
			}

			const getElements = function(type){

				return dataRaw[type];
			}

			const getElementId = function(name, type){
				const elements = getElements(type);
				let id=-1;
				elements.forEach(el=> {
					if(el.nombre==name){
						id=el.id;
					}
				});
				return id;
			}

			const deleteElement = function(name, type){
				const elements = getElements(type);
				const dEl = getElementId(name, type);
				if(dEl!=-1){
					elements.splice(elements.findIndex(el=>el.id===dEl),1);
					deleteMethod(type, dEl);
					dataRaw[type]=elements;
					classifyInfo(dataRaw);
				}
				else{
					console.error('Element does not exist');
				}
			}

			const deleteMovie = function(){
				if(selected!=undefined){
					deleteElement(selected.nombre, 'peliculas');
				}
				else{
					window.alert('Movie does not exist');
				}
			}

			const editElement = function(type, ...args){
				try{
					const oldElements = getElements(type);
					const newElements=oldElements;
					const id = getElementId(args[0], type)
					let newElement={};
					if(type==='clasificaciones'&&args.length===2){
						newElement={'id':id, 'nombre':args[1]} 
					} else if(type==='peliculas'&&args.length===4){
						console.log(args[0]);
						console.log(args[1]);
						newElement={'id':id,'nombre':args[1],'director':args[2], 'clasificacion':args[3]};			
					} else {
						throw new Error('Bad parameter pass.')
					}
					console.log("Elemento editado");
					console.log(newElement);
					const index=newElements.findIndex(el=>el.id===id);
					newElements[index]=newElement;				
					const newList = dataRaw;
					newList[type]=newElements;
					classifyInfo(newList);
					postMethod(type, newElements[index], id);
					dataRaw=newList;
				}catch(err){console.error(err.message);}
			}

			const toggleHidden = function(){
				const check = document.getElementById('adminEnable');
				const formAdminAdd = document.getElementById('adminControl_addMovie');
				const formAdminEdDel = document.getElementById('adminControl_edDelMovie');
				const formAdminAddFieldset = document.getElementById('adminControl_addMovie_Fieldset');
				const formAdminEdDelFieldset = document.getElementById('adminControl_edDelMovie_Fieldset');
				if(check.checked===true){
					formAdminAdd.hidden=false;
					formAdminEdDel.hidden=false;
					formAdminAddFieldset.hidden=false;
					formAdminEdDelFieldset.hidden=false;
				}
				else{
					formAdminAdd.hidden=true;
					formAdminEdDel.hidden=true;
					formAdminAddFieldset.hidden=true;
					formAdminEdDelFieldset.hidden=true;
				}
			}

		</script>
		<link rel="stylesheet" href="styles.css"></style>
	</head>
	<body>
		<header id="header" class="header">
				<h1 id="header_title" class="title">WeinmanClub</h1>
				<h2 id="header_subtitle" class="subtitle">Movies. Movies Everywhere</h2>
			<nav id="header_demoNav" class="demoNav">
				<p>Here goes some urls to other pages. (same thing, but bootstrap, etc)</p>
				<!--When making stuff with bootstrap, jquery, etc, I will add links here-->
			</nav>
		</header>
		<main id="mainBody" class="mainBody">
			<aside class="picture-small" id="top-left"></aside>
			<aside class="picture-main" id="main-left"></aside>
			<aside class="picture-small" id="top-right"></aside>
			<aside class="picture-main" id="main-right"></aside>
			<div class=gridfit>
				<section id="mainBody_aboutUs" class="nonImportant">
					<article id="mainBody_aboutUs_articleOne" class="nonImportantArticle">
						<h3 id="mainBody_aboutUs_articleOne_unimportantH3" class="unimportantH3">Rent and buy movies</h3>
						<p id="mainBody_aboutUs_articleOne_unimportant_p1" class="unimportantP">Hello there, we have movies for rental and sell. We also buy old movies 
						because we are movie maniacs. <span>And now, some lore ipsum stuff</span>
						</p>
						<p id="mainBody_aboutUs_articleOne_unimportant_p2" class="unimportantP">Cras quis tristique risus. Fusce efficitur tellus eget vestibulum pretium. In hac habitasse platea dictumst. Suspendisse potenti. Interdum et malesuada fames ac ante ipsum primis in faucibus. Donec quam dolor, pharetra nec velit nec, dapibus interdum orci. Proin et imperdiet tortor, at dignissim neque. In malesuada lectus ut risus auctor, vitae molestie tellus gravida. Nam nisl ipsum, fringilla in feugiat sit amet, fringilla nec est. Sed maximus at magna ac cursus. Suspendisse blandit hendrerit orci, at hendrerit leo sollicitudin et. Cras bibendum tempor libero, et mollis ex pulvinar sit amet. Vivamus sit amet lorem tempus, finibus ipsum in, pretium turpis. In sollicitudin tincidunt dapibus. Maecenas efficitur enim sapien, congue vestibulum lacus tristique nec.</p>
					</article>
				</section>
				<section id="mainBody_movies" class="important">
					<ul id="mainBody_movies_movieList" class="important_ul">
					</ul>
					<p id="mainBody_movies_p" class="important_p">Since this page was created for the API purpose, no roles are created. I could. However, I am doing that with React, Vue and Angular apps. Enjoy managing this web as if you were the owner.</p>
				</section>
				<section id=mainbody_adminfeatures class="important_form">
					<input id="adminEnable" type="checkbox" name="adminEnable" onclick='toggleHidden()' />
					<form class="admin" id="adminControl_addMovie" hidden>
						<fieldset hidden id="adminControl_addMovie_Fieldset">
							<legend>Add a movie</legend>
								<label for="nombre"><span>Nombre</span><input type="text" name="nombre"/></label>
								<label for="director"><span>Director</span><input type="text" name="director"/></label>
								<label for="clasificacion"><span>Clasificacion</span>
									<select name="clasificacion" id="selClasificaciones">
									</select>
								</label>
								<button onclick="addMovie()">Añadir</button>
						</fieldset>							
					</form>
					<form class="admin" id="adminControl_edDelMovie" hidden>
						<fieldset hidden id="adminControl_edDelMovie_Fieldset">
							<legend>Edit or delete a movie</legend>
								<label for="idMovie" id="idMovie"><span>Id</span><textarea rows=1 cols=4 readonly></textarea></label>
								<label for="nombre"><span>Nombre</span><input type="text" name="nombre"/></label>
								<label for="director"><span>Director</span><input type="text" name="director"/></label>
								<label for="clasificacion"><span>Clasificacion</span><input type="text" name="clasificacion"/></label>
								<button onclick="deleteMovie(this)">Delete</button>
								<button onclick="editMovie(this)">Editar</button>
						</fieldset>			
					</form>
				</section>
			</div>
		</main>
		<footer id="aboutMe" class="final_footer">
			<aside class="picture-small" id="bottom-left"></aside>
			<aside class="picture-small" id="bottom-right"></aside>
			<div>
				<p>Done by Weinman. No copyright, no copyleft. Pure copycenter.</p>
				<a id="aboutMe_contributor" href='https://www.freepik.es/vectores/fondo'>Image done by starline - www.freepik.es</a>
			</div>
		</footer>
	</body>
</html>