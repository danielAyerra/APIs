<!DOCTYPE html>
<html>
<head>
	<title>Your favourite Videoclub is here!</title>
	<script type="text/javascript" src="requestAPI.js"></script>
	<script type="text/javascript">
		let dataRaw;
		window.onload = async function(){
			const res = await getMethod();
			dataRaw = res;
			classifyInfo(res);
		}

		const classifyInfo = function(data){
			let content='';
			if(data['peliculas']&&data['clasificaciones']){
				const movies=data['peliculas'];
				const classes=data['clasificaciones'];
				for(let i=0;i<classes.length;i++){
					const clasMovies = searchInfo(movies, classes[i].nombre);
					content+=`<li>${classes[i].nombre} <ul>`;
					for(let j=0;j<clasMovies.length;j++){
						content+=`<li>${clasMovies[j].nombre}</li>`;
					}
					content+='</ul></li>';
				}
			}
			document.getElementById('movieList').innerHTML=content;
		}

		const searchInfo = function(data, term){
			const returnElement = data.filter(el=>el['clasificacion']==term);
			return returnElement;
		}

		const addElement = function(type, ...args){//nombre, director, clasificación
			try{
				const oldElements = getElements(type);
				const newElements=oldElements;
				if(type==='clasificaciones'&&args.length===1){
					newElements.push({'nombre':args[0], 'id':oldElements.length+1});
					console.log(newElements);
				} else if(type==='peliculas'&&args.length===3){						
					newElements.push({'nombre':args[0], 'director':args[1], 'clasificacion':args[2], 'id':oldElements.length+1});
					console.log(newElements)
				} else {
					throw new Error('Bad parameter pass.')
				}				
				const newList = dataRaw;
				newList[type]=newElements;
				classifyInfo(newList);
				putMethod(type, newElements[newElements.length-1], newElements.length);
				dataRaw=newList;
			}catch(err){console.error(err.message);}
		}

		const getElements = function(type){

			return dataRaw[type];
		}

		const getElementId = function(name, type){
			const elements = getElements(type);
			let id=-1;
			elements.forEach(el=> {
				if(el.nombre==name){
					id=el.id;
				}
			});
			return id;
		}

		const deleteElement = function(name, type){
			const elements = getElements(type);
			const dEl = getElementId(name, type);
			if(dEl!=-1){
				elements.splice(elements.findIndex(el=>el.id===dEl),1);
				deleteMethod(type, dEl);
				dataRaw[type]=elements;
				classifyInfo(dataRaw);
			}
			else{
				console.error('Element does not exist');
			}
		}

		const editElement = function(type, ...args){
			try{
				const oldElements = getElements(type);
				const newElements=oldElements;
				const id = getElementId(args[0], type)
				let newElement={};
				if(type==='clasificaciones'&&args.length===2){
					newElement={'id':id, 'nombre':args[1]} 
				} else if(type==='peliculas'&&args.length===4){
					console.log(args[0]);
					console.log(args[1]);
					newElement={'id':id,'nombre':args[1],'director':args[2], 'clasificacion':args[3]};			
				} else {
					throw new Error('Bad parameter pass.')
				}
				console.log("Elemento editado");
				console.log(newElement);
				const index=newElements.findIndex(el=>el.id===id);
				newElements[index]=newElement;				
				const newList = dataRaw;
				newList[type]=newElements;
				classifyInfo(newList);
				postMethod(type, newElements[index], id);
				dataRaw=newList;
			}catch(err){console.error(err.message);}
		}

	</script>
</head>
<body>
	<header>
			<h1>WeinmanClub</h1>
			<h2>Movies. Movies Everywhere</h2>
		<nav></nav>
	</header>
	<main>
		<section>
			<article>
				<p>Párrafo sobre lo guays que somos. Añadir un subtítulo h3
				</p>
			</article>
		</section>
		<section>
			<ul id="movieList">
				<li>Lista de pelis traídas desde mock server</li>
			</ul>
		</section>
	</main>
	<footer>
		Done by Weinman. No copyright, no copyleft. Pure copycenter.
	</footer>
</body>
</html>